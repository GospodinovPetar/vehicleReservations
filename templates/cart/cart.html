{% extends "base.html" %}
{% block content %}
  <h3>Your Cart</h3>

  <div class="card">
    {% if rows %}
      <div class="row" style="justify-content:space-between; align-items:center; margin-bottom:.5rem;">
        <div><strong>{{ rows|length }}</strong> item{{ rows|length|pluralize }} in cart</div>
      </div>

      <table>
        <thead>
          <tr>
            <th>Vehicle</th>
            <th>Pickup</th>
            <th>Return</th>
            <th>From</th>
            <th>To</th>
            <th style="text-align:right;">Days</th>
            <th style="text-align:right;">Total</th>
            <th style="width:1%;"></th>
          </tr>
        </thead>
        <tbody>
          {% for row in rows %}
            <tr>
              <td>
                {% with vid=row.item.vehicle_id v=row.item.vehicle %}
                  {% if vid %}
                    <a href="{% url 'accounts:vehicle-profile' vid %}">
                      {% if v and v.display_name %}
                        {{ v.display_name }}
                      {% elif v and v.name %}
                        {{ v.name }}
                      {% elif v and v.make %}
                        {{ v.make }}{% if v.model %} {{ v.model }}{% endif %}
                      {% elif v and v.model %}
                        {{ v.model }}
                      {% elif row.item.vehicle_name_snapshot %}
                        {{ row.item.vehicle_name_snapshot }}
                      {% else %}
                        {{ v|default:"(deleted vehicle)" }}
                      {% endif %}
                    </a>
                  {% else %}
                    <span class="text-muted">
                      {% if v and v.display_name %}
                        {{ v.display_name }}
                      {% elif v and v.name %}
                        {{ v.name }}
                      {% elif v and v.make %}
                        {{ v.make }}{% if v.model %} {{ v.model }}{% endif %}
                      {% elif v and v.model %}
                        {{ v.model }}
                      {% elif row.item.vehicle_name_snapshot %}
                        {{ row.item.vehicle_name_snapshot }}
                      {% else %}
                        —
                      {% endif %}
                    </span>
                  {% endif %}
                {% endwith %}
              </td>

              <td>
                {% with loc=row.item.pickup_location %}
                  {% if loc %}
                    {% if loc.display_name %}{{ loc.display_name }}
                    {% elif loc.name %}{{ loc.name }}
                    {% else %}{{ loc }}{% endif %}
                  {% else %}—{% endif %}
                {% endwith %}
              </td>

              <td>
                {% with loc=row.item.return_location %}
                  {% if loc %}
                    {% if loc.display_name %}{{ loc.display_name }}
                    {% elif loc.name %}{{ loc.name }}
                    {% else %}{{ loc }}{% endif %}
                  {% else %}—{% endif %}
                {% endwith %}
              </td>

              <td>{{ row.item.start_date|date:"Y-m-d" }}</td>
              <td>{{ row.item.end_date|date:"Y-m-d" }}</td>
              <td style="text-align:right;">{{ row.days }}</td>
              <td style="text-align:right;">
                {% if row.total is not None %}
                  {{ row.total|floatformat:2 }} EUR
                {% else %}
                  {{ row.item.total_price|default:0|floatformat:2 }} EUR
                {% endif %}
              </td>
              <td>
                <form method="post" action="{% url 'cart:remove_from_cart' row.item.id %}" style="display:inline;">
                  {% csrf_token %}
                  <button class="btn" type="submit">Remove</button>
                </form>
              </td>
            </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr>
            <td colspan="6" style="text-align:right;"><strong>Cart total:</strong></td>
            <td style="text-align:right;">
              <strong>
                {% if cart_total is not None %}
                  {{ cart_total|floatformat:2 }} EUR
                {% else %}
                  0.00 EUR
                {% endif %}
              </strong>
            </td>
            <td></td>
          </tr>
        </tfoot>
      </table>

      <div class="row" style="justify-content:flex-end; gap:8px; margin-top:12px;">
        <form method="post" action="{% url 'cart:checkout' %}">
          {% csrf_token %}
          <button class="btn primary" type="submit">Checkout</button>
        </form>
      </div>
    {% else %}
      <p>Your cart is empty.</p>
    {% endif %}
  </div>
{% endblock %}
