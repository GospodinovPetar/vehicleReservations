{% extends "base.html" %}
{% block content %}
  <h3>My Reservations</h3>

  <div class="card">
    {% if groups %}
      {% for g in groups %}
        <div style="margin: .5rem 0;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:.5rem;">
            <div>
              <strong>Reference:</strong> {{ g.reference }}
              <em>({{ g.created_at }})</em>
            </div>
            <form method="post" action="{% url 'inventory:cancel_group' g.id %}">
              {% csrf_token %}
              <button class="btn">Cancel Group</button>
            </form>
          </div>

          <table>
            <thead>
              <tr>
                <th>User</th>
                <th>Vehicle</th>
                <th>Dates</th>
                <th>Pickup → Return</th>
                <th>Status</th>
                <th>Total</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% with active_count=g.reservations.all|length %}
                {% for r in g.reservations.all %}
                  <tr>
                    <td>{{ r.user }}</td>
                    <td>{{ r.vehicle }}</td>
                    <td>{{ r.start_date|date:"Y-m-d" }} → {{ r.end_date|date:"Y-m-d" }}</td>
                    <td>{{ r.pickup_location }} → {{ r.return_location }}</td>
                    <td>{{ r.status }}</td>
                    <td>{{ r.total_price|floatformat:2 }} EUR</td>
                    <td>
                      <a class="btn" href="{% url 'inventory:edit_reservation' r.id %}">Edit</a>
                      {% if active_count > 1 %}
                        <form method="post" action="{% url 'inventory:delete_reservation' r.id %}" style="display:inline;">
                          {% csrf_token %}
                          <button class="btn">Delete</button>
                        </form>
                      {% else %}
                        <button class="btn" disabled title="Cannot remove the only vehicle">Delete</button>
                      {% endif %}
                    </td>
                  </tr>
                {% empty %}
                  <tr>
                    <td colspan="7">This group has no active reservations.</td>
                  </tr>
                {% endfor %}
              {% endwith %}
            </tbody>
          </table>
        </div>
      {% endfor %}
    {% else %}
      <p>No reservations have been made yet.</p>
    {% endif %}
  </div>

  <div class="card" style="margin-top:1rem;">
    <h4>Rejected / Canceled</h4>

    {% if canceled %}
      <table>
        <thead>
          <tr>
            <th>User</th>
            <th>Vehicle</th>
            <th>Dates</th>
            <th>Pickup → Return</th>
            <th>Status</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody>
          {% for r in canceled %}
            <tr>
              <td>{{ r.user }}</td>
              <td>{{ r.vehicle }}</td>
              <td>{{ r.start_date|date:"Y-m-d" }} → {{ r.end_date|date:"Y-m-d" }}</td>
              <td>{{ r.pickup_location }} → {{ r.return_location }}</td>
              <td>{{ r.status }}</td>
              <td>{{ r.total_price|floatformat:2 }} EUR</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p>No rejected/canceled reservations.</p>
    {% endif %}
  </div>
{% endblock %}
